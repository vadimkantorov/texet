<!doctype html>
  <html>
    <head>
      <script src="https://mozilla.github.io/pdf.js/build/pdf.js"></script>
      <script src="https://mozilla.github.io/pdf.js/build/pdf.worker.js"></script>
      
      <link rel="stylesheet" href="https://unpkg.com/xterm@3.8.0/dist/xterm.css" />
      <script src="https://unpkg.com/xterm@3.8.0/dist/xterm.js"></script>
      <script src="https://unpkg.com/xterm@3.8.0/dist/addons/fit/fit.js"></script>
      <script src="https://unpkg.com/monaco-editor@latest/min/vs/loader.js"></script>
      <style>
        
        html, body{
          height: 100%;
          width: 100%;
          margin: 0;
          padding: 0;
        }
        #editor
        {
            height:50%;
            width: 50%;
            float:left;
        }
        #viewer
        {
            height:50%;
            width: 50%;
            float:right;
        }
        #terminal {
            height:45%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        .xterm-viewport {
            overflow-y: hidden !important
        }
        #footer {
            width: 100%;
            margin: 0;
            padding: 0;
            background-color: gray;
            height: auto;
            position: fixed;
            bottom: 0; 
        }
        /*#pdfcanvas{ width:100%; height: 100%}*/
      </style>


    </head>
    <body>
      <div id="editor"></div>
      <div id="viewer"><img hidden id="imgcanvas"></img><canvas id="pdfcanvas"></canvas></div>
      <div id="terminal"></div>
      <div id="footer" class="emscripten">
         <label id="status" for="progress">Downloading Emscripten...</label>
         <progress id="progress" value="0" max="100">0%</progress>
      </div>
      <script>
        async function clone(https_path, repo_path)
        {
            const resp = await fetch(https_path.replace('github.com', 'api.github.com/repos') + '/contents');
            const repo = await resp.json();
            FS.mkdir(repo_path);
            for(const file of repo)
            {
                const resp = await fetch(file.download_url);
                const contents = await resp.text();
                const file_path = `${repo_path}/${file.name}`;
                FS.writeFile(file_path, contents);
            }
        }
        
        async function push(relative_file_path, repo_path)
        {
            console.log(relative_file_path, repo_path);
        }
        
        function get_text()
        {
            return window.monaco_editor.getModel().getValue();
        }

        function expanduser(path)
        {
            return path.replace('~', '/home');
        }

        function ls(path)
        {
            return Object.keys(FS.lookupPath(path).node.contents);
        }

        function mkdir(path)
        {
            FS.mkdir(path);
        }
        
        function cd(path)
        {
            FS.chdir(path);
        }

        function edit(contents)
        {
            window.monaco_editor.getModel().setValue(contents);
        }

        function open(contents, file_path)
        {
            const imgcanvas = document.getElementById('imgcanvas'), pdfcanvas = document.getElementById('pdfcanvas');
            if(file_path.endsWith('.svg'))
            {
                [imgcanvas.hidden, pdfcanvas.hidden] = [false, true];
                imgcanvas.src = `data:image/svg+xml;base64,` + btoa(String.fromCharCode.apply(null, contents));
            }
            else if(file_path.endsWith('.png') || file_path.endsWith('.jpg'))
            {
                [imgcanvas.hidden, pdfcanvas.hidden] = [false, true];
                const ext = file_path.endsWith('.png') ? 'png' : 'jpg';
                imgcanvas.src = `data:image/${ext};base64,` + btoa(String.fromCharCode.apply(null, contents));
            }
            else if(file_path.endsWith('.pdf'))
            {
                [imgcanvas.hidden, pdfcanvas.hidden] = [true, false];
                var loadingTask = window.pdf.getDocument({data: contents}).promise.then(function(pdf) {
                    console.log('PDF loaded');

                    // Fetch the first page
                    var pageNumber = 1;
                    pdf.getPage(pageNumber).then(function(page) {
                        console.log('Page loaded');

                        const scale = 1.5;
                        const viewport = page.getViewport({scale: scale});

                        // Prepare canvas using PDF page dimensions
                        const context = pdfcanvas.getContext('2d');
                        pdfcanvas.height = viewport.height;
                        pdfcanvas.width = viewport.width;

                        // Render PDF page into canvas context
                        const renderContext = {
                            canvasContext: context,
                            viewport: viewport
                        };
                        const renderTask = page.render(renderContext);
                        renderTask.promise.then(function () {
                            console.log('Page rendered');
                        });
                    });
                }, function(reason) {
                    console.error(reason);
                });
            }
        }

        var pdfData = atob(
              'JVBERi0xLjcKCjEgMCBvYmogICUgZW50cnkgcG9pbnQKPDwKICAvVHlwZSAvQ2F0YWxvZwog' +
              'IC9QYWdlcyAyIDAgUgo+PgplbmRvYmoKCjIgMCBvYmoKPDwKICAvVHlwZSAvUGFnZXMKICAv' +
              'TWVkaWFCb3ggWyAwIDAgMjAwIDIwMCBdCiAgL0NvdW50IDEKICAvS2lkcyBbIDMgMCBSIF0K' +
              'Pj4KZW5kb2JqCgozIDAgb2JqCjw8CiAgL1R5cGUgL1BhZ2UKICAvUGFyZW50IDIgMCBSCiAg' +
              'L1Jlc291cmNlcyA8PAogICAgL0ZvbnQgPDwKICAgICAgL0YxIDQgMCBSIAogICAgPj4KICA+' +
              'PgogIC9Db250ZW50cyA1IDAgUgo+PgplbmRvYmoKCjQgMCBvYmoKPDwKICAvVHlwZSAvRm9u' +
              'dAogIC9TdWJ0eXBlIC9UeXBlMQogIC9CYXNlRm9udCAvVGltZXMtUm9tYW4KPj4KZW5kb2Jq' +
              'Cgo1IDAgb2JqICAlIHBhZ2UgY29udGVudAo8PAogIC9MZW5ndGggNDQKPj4Kc3RyZWFtCkJU' +
              'CjcwIDUwIFRECi9GMSAxMiBUZgooSGVsbG8sIHdvcmxkISkgVGoKRVQKZW5kc3RyZWFtCmVu' +
              'ZG9iagoKeHJlZgowIDYKMDAwMDAwMDAwMCA2NTUzNSBmIAowMDAwMDAwMDEwIDAwMDAwIG4g' +
              'CjAwMDAwMDAwNzkgMDAwMDAgbiAKMDAwMDAwMDE3MyAwMDAwMCBuIAowMDAwMDAwMzAxIDAw' +
              'MDAwIG4gCjAwMDAwMDAzODAgMDAwMDAgbiAKdHJhaWxlcgo8PAogIC9TaXplIDYKICAvUm9v' +
              'dCAxIDAgUgo+PgpzdGFydHhyZWYKNDkyCiUlRU9G');

        window.pdf = window['pdfjs-dist/build/pdf'];

        // The workerSrc property shall be specified.
        window.pdf.GlobalWorkerOptions.workerSrc = '//mozilla.github.io/pdf.js/build/pdf.worker.js';

        // Using DocumentInitParameters object to load binary data.
        open(pdfData, 'helloworld.pdf');
        

        //import { FitAddon } from 'fit.js';
        window.terminal = new Terminal();
        //fitAddon = new FitAddon();
        //term.loadAddon(fitAddon);
        window.terminal.open(document.getElementById('terminal'));
        //fitAddon.fit();
        window.terminal.prompt = () => window.terminal.write((typeof(FS) == 'undefined' ? '/' : FS.cwd()) + '$ ');
        window.terminal.prompt();
        var curLine = '';
        window.terminal.on('key', async (key, ev) => {
            if(ev.keyCode == 8)
            {
                if(curLine.length > 0)
                {
                    curLine = curLine.slice(0, curLine.length - 1);
                    window.terminal.write('\b \b');
                }
            }
            else if(ev.keyCode == 13)
            {
                //https://stackoverflow.com/questions/46943653/how-to-pass-char-array-to-emscripten-compiled-code
                //var result = Module.ccall('main', 'number', ['number', ], args);
                
                const newline = '\r\n';
                const ok = 'ok!' + newline;
                window.terminal.write(newline);
                const [cmd, arg] = curLine.split(' ');
                try
                {
                    if (cmd == '')
                    {
                    }
                    else if(cmd == 'ls')
                    {
                        const res = ls(arg || '.');
                        window.terminal.write(res.join(' ') + newline);
                    }
                    else if(cmd == 'mkdir')
                    {
                        mkdir(arg);
                    }
                    else if(cmd == 'cd')
                    {
                        cd(arg);
                    }
                    else if(cmd == 'clone')
                    {
                        await clone(arg, 'repo');
                        window.terminal.write(ok);
                    }
                    else if(cmd == 'push')
                    {
                        await push(arg, 'repo');
                        window.terminal.write(ok);
                    }
                    else if(cmd == 'open')
                    {
                        if(arg.endsWith('.pdf') || arg.endsWith('.jpg') || arg.endsWith('.png') || arg.endsWith('.svg'))
                            open(FS.readFile(arg, {encoding : 'binary'}), arg);
                        else
                            edit(FS.readFile(arg, {encoding : 'utf8'}));
                    }
                    else if(cmd == 'save')
                    {
                        FS.writeFile(arg, get_text());
                        window.terminal.write(ok);
                    }
                    else
                    {
                        window.terminal.write(cmd + ': command not found' + newline);
                    }
                }
                catch(err)
                {
                    window.terminal.write('Error: ' +  err.message + newline);
                }
                window.terminal.prompt();
                curLine = '';
            }
            else
            {
                curLine += key;
                window.terminal.write(key);
            }
            
            //window.terminal.element.scrollIntoView(true);
        });
        
        require.config({ paths: { 'vs': 'https://unpkg.com/monaco-editor@latest/min/vs' }});
        window.MonacoEnvironment = { getWorkerUrl: () => proxy };
        let proxy = URL.createObjectURL(new Blob([`
          self.MonacoEnvironment = {
            baseUrl: 'https://unpkg.com/monaco-editor@latest/min/'
          };
          importScripts('https://unpkg.com/monaco-editor@latest/min/vs/base/worker/workerMain.js');
        `], { type: 'text/javascript' }));

        require(["vs/editor/editor.main"], function () {
          window.monaco_editor = monaco.editor.create(document.getElementById('editor'), {theme: 'vs-dark'});
        });

      </script>
    <script type='text/javascript'>
      var statusElement = document.getElementById('status');
      var progressElement = document.getElementById('progress');

      var Module = {
        noInitialRun : true,
        preRun: [],
        postRun: [],
        print: (function() {
          return function(text) {
            if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
            if (element) {
              window.terminal.write(text + '\r\n');
            }
          };
        })(),
        printErr: function(text) {
          if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
          console.error(text);
        },
        setStatus: function(text) {
          if (!Module.setStatus.last) Module.setStatus.last = { time: Date.now(), text: '' };
          if (text === Module.setStatus.last.text) return;
          var m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
          var now = Date.now();
          if (m && now - Module.setStatus.last.time < 30) return; // if this is a progress update, skip it if too soon
          Module.setStatus.last.time = now;
          Module.setStatus.last.text = text;
          if (m) {
            text = m[1];
            progressElement.value = parseInt(m[2])*100;
            progressElement.max = parseInt(m[4])*100;
          } else {
            progressElement.value = null;
            progressElement.max = null;
          }
          statusElement.innerHTML = text.length > 0 ? text : 'Downloaded Emscripten!';
        },
        totalDependencies: 0,
        monitorRunDependencies: function(left) {
          this.totalDependencies = Math.max(this.totalDependencies, left);
          Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies-left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
        }
      };
      Module.setStatus('Downloading Emscripten...');
      window.onerror = function(event) {
        Module.setStatus('Exception thrown, see JavaScript console');
        Module.setStatus = function(text) {
          if (text) Module.printErr('[post-exception status] ' + text);
        };
      };
    </script>
    <script async type="text/javascript" src="cat.js"></script>
    </body>
  </html>
